<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Editor and CSV Exporter</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Custom scrollbar for table container */
        .table-container::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        .table-container::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 6px;
            border: 3px solid #f3f4f6;
        }
        .table-container::-webkit-scrollbar-track {
            background-color: #f3f4f6;
        }
        /* Style for editable cells and selects */
        .editable-cell, .editable-select {
            width: 100%;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #d1d5db;
            transition: all 0.15s;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        .editable-cell:focus, .editable-select:focus {
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }
        td {
            padding: 4px;
            vertical-align: top;
            min-width: 150px;
        }
        th {
            position: sticky;
            top: 0;
            background-color: #ffffff;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            min-width: 150px;
        }
        /* Modal backdrop and content */
        .modal {
            display: none;
        }
        .modal.open {
            display: flex;
        }
    </style>
</head>
<body class="p-4 md:p-8">

<!-- Title and Controls -->
<div class="max-w-7xl mx-auto mb-6 bg-white p-6 rounded-xl shadow-lg">
    <h1 class="text-3xl font-extrabold text-gray-900 mb-2">CSV Data Editor</h1>
    <p class="text-gray-600 mb-6">Edit data, manage dropdown options for categorical columns, and export the result.</p>

    <div class="flex flex-wrap gap-4 items-center">
        <button id="manage-options-btn" class="flex-shrink-0 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150">
            Manage Options
        </button>
        <button id="export-csv-btn" class="flex-shrink-0 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150">
            Export Data to CSV
        </button>
        <!-- Optional: File input for loading other CSVs -->
        <input type="file" id="file-input" accept=".csv" class="flex-grow max-w-xs text-sm text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-indigo-700 hover:file:bg-violet-100">
    </div>
</div>

<!-- Data Table Container -->
<div class="max-w-7xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden">
    <div id="table-container" class="table-container p-4 overflow-x-auto overflow-y-auto max-h-[70vh]">
        <table id="data-table" class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50"></thead>
            <tbody class="bg-white divide-y divide-gray-200"></tbody>
        </table>
        <p id="loading-message" class="text-center text-gray-500 py-10">Loading data...</p>
    </div>
</div>

<!-- Options Management Modal -->
<div id="options-modal" class="modal fixed inset-0 z-50 items-center justify-center bg-gray-900 bg-opacity-75 transition-opacity duration-300">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 m-4 transform transition-all duration-300 scale-95 opacity-0" id="modal-content">
        <h2 class="text-2xl font-bold mb-4">Manage Enum Options</h2>

        <div class="mb-4">
            <label for="column-select" class="block text-sm font-medium text-gray-700 mb-1">Select Column:</label>
            <select id="column-select" class="editable-select"></select>
        </div>

        <div class="mb-4">
            <label for="options-textarea" class="block text-sm font-medium text-gray-700 mb-1">Available Options (one per line):</label>
            <textarea id="options-textarea" rows="8" class="editable-cell resize-y"></textarea>
        </div>

        <div id="modal-message" class="text-sm text-red-500 mb-4 hidden"></div>

        <div class="flex justify-end space-x-3">
            <button id="save-options-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150">
                Save Changes
            </button>
            <button id="close-modal-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg transition duration-150">
                Close
            </button>
        </div>
    </div>
</div>

<script>
    // --- 1. CONFIGURATION AND INITIAL DATA ---
    const ENUM_THRESHOLD = 4; // Columns with <= 4 unique values are considered enums

    // CSV data pre-loaded from the user's file snippet
    const RAW_CSV_DATA = `ID,Book,Chapter,Verse,TokenID,GreekText,IllocutionaryForce,Modality,Stance,Evidentiality,Face,Veridicality,EntailmentPattern,InferenceType,IsCancelled,Code,Prejacent,PresuppositionType,ImplicatureType,InvitedInference,IsScalar,ScaleType,Alternative,IsExhausted,PredicationType,Question-Under-Discussion,InferredProposition,Information_Structure,Notes,,,
,Philemon,1,1,"57001001-01, 57001001-02, 57001001-03, 57001001-04",ΠΑΥΛΟΣ ΔΕΣΜΙΟΣ ΧΡΙΣΤΟΥ ΙΗΣΟΥ,N/A,Realis,Identity,N/A,N/A,Veridical,N/A,Implicature,FALSE,DefiniteDescription,"Paul is in prison because of Jesus",N/A,Particularized Conversational,N/A,FALSE,N/A,N/A,N/A,"Appositive predication, Defining","Global implicit QUD: What should Philemon do about Onesimus?","Paul is like Onesimus because he also has a master.",,"Choice of description is marked. Paul is presequencing to prepare for a latter, potentially face-threatening act. Paul explicitly honors Philemon and implicitly positions him as aligned with Paul’s mission and values. Paul anticipates that Philemon will behave accordingly when asked (especially in v. 8–10ff). Affiliative presequencing: Paul’s identifier is that he is a slave of Jesus Christ, no other identifier. Jesus is a master to Paul, but he...",,,
,Philemon,1,12,"570010120010, 570010120020, 570010120030, 570010120040",ΟΝ ΗΓΑΠΗΜΕΝΕ,N/A,N/A,Attitudinal,N/A,N/A,N/A,N/A,N/A,FALSE,Interjection,N/A,N/A,N/A,N/A,FALSE,N/A,N/A,N/A,N/A,"Paul is using an affective address: he is feeling a lack of love from his church in Rome.",N/A,N/A,"Paul is presequencing, trying to mitigate the face threat inherent in asking Philemon to do something. He emphasizes his deep affection for him. There is a sense of 'If you love me, then you will do this thing.'",,,
,Philemon,1,17,"570010170010, 570010170020, 570010170030, 570010170040",ΕΙ ΟΥΝ ΜΕ ΕΧΕΙΣ ΚΟΙΝΩΝΟΝ,N/A,Hypothetical,N/A,N/A,N/A,Veridical,N/A,N/A,FALSE,Conjunction,N/A,N/A,N/A,N/A,FALSE,N/A,N/A,N/A,N/A,"QUD: Does Paul have the right to request this action?","Paul is appealing to Philemon's prior relationship/commitment to Paul to justify the request.",,"The conditional is of the 'If X then Y' type, where X is taken to be true. Paul is using the first part as a premise for the second part (v. 17b). This acts as a presequencing element.",,,
,Philemon,1,21,"570010210010, 570010210020, 570010210030, 570010210040, 570010210050, 570010210060, 570010210070, 570010210080, 570010210090, 570010210100, 570010210110, 570010210120010, 570010210130010, 570010210140010",ΠΕΠΟΙΘΩΣ ΤΗ ΥΠΑΚΟΗ ΣΟΥ ΕΓΡΑΨΑ ΣΟΙ ΕΙΔΩΣ ΟΤΙ ΚΑΙ ΥΠΕΡ Ο ΖΗΤΩ ΠΟΙΗΣΕΙΣ,N/A,Realis,Epistemic,Attitudinal,N/A,Veridical,N/A,N/A,FALSE,Verb,N/A,N/A,N/A,N/A,FALSE,N/A,N/A,N/A,N/A,,N/A,,"Attitude report is used as a hedge (Paul is not asking something unreasonable, given the character of Philemon). Character sequencing reaches a crescendo. Paul expects more than the baseline. Will Philemon live up to his reputation?",,,
,Philemon,1,22,"570010220010010, 570010220020010",ΑΜΑ ΔΕ ΚΑΙ,N/A,N/A,N/A,N/A,N/A,N/A,N/A,N/A,FALSE,Verb,N/A,N/A,N/A,N/A,TRUE,N/A,N/A,FALSE,N/A,,Paul is adding this directive to the previous sequence of directives: receive and refresh,,,,
,Philemon,1,22,"570010220030010, 570010220040010, 570010220050010",ΕΤΟΙΜΑΖΕ ΜΟΙ ΞΕΝΙΑΝ,N/A,Directive,N/A,N/A,N/A,N/A,N/A,N/A,FALSE,Verb,N/A,N/A,N/A,N/A,FALSE,N/A,N/A,N/A,N/A,"QUD: Should Philemon prepare a guest room for Paul?","Paul is directing Philemon to prepare a guest room for him.",,"This is a command, and is a pre-sequence (Paul is anticipating his arrival).",,,
,Philemon,1,23,570010230010,ΕΠΑΦΡΑΣ,N/A,N/A,Identity,N/A,N/A,N/A,N/A,N/A,FALSE,Noun,N/A,N/A,N/A,N/A,FALSE,N/A,N/A,N/A,N/A,,N/A,,"This serves to introduce Epaphras to Philemon, and it serves an affiliative function.",,,
,Philemon,1,23,570010230020,Ο ΣΥΝΑΙΧΜΑΛΩΤΟΣ,N/A,Realis,Identity,N/A,N/A,Veridical,N/A,N/A,FALSE,DefiniteDescription,Epaphras is a fellow prisoner,N/A,N/A,N/A,FALSE,N/A,N/A,N/A,"Appositive predication, Defining",Global implicit QUD: Who is Epaphras?,Epaphras is a fellow worker.,,"The appositive phrase is marked, as it emphasizes the strong commitment of Epaphras to the gospel, and it serves an affiliative function.",,,
,Philemon,1,24,570010240010,ΜΑΡΚΟΣ,N/A,N/A,Identity,N/A,N/A,N/A,N/A,N/A,FALSE,Noun,N/A,N/A,N/A,N/A,FALSE,N/A,N/A,N/A,N/A,,N/A,,"This serves to introduce Mark to Philemon, and it serves an affiliative function.",,,
,Philemon,1,24,570010240020,ΑΡΙΣΤΑΡΧΟΣ,N/A,N/A,Identity,N/A,N/A,N/A,N/A,N/A,FALSE,Noun,N/A,N/A,N/A,N/A,FALSE,N/A,N/A,N/A,N/A,,N/A,,"This serves to introduce Aristarchus to Philemon, and it serves an affiliative function.",,,
,Philemon,1,24,570010240030,ΔΗΜΑΣ,N/A,N/A,Identity,N/A,N/A,N/A,N/A,N/A,FALSE,Noun,N/A,N/A,N/A,N/A,FALSE,N/A,N/A,N/A,N/A,,N/A,,"This serves to introduce Demas to Philemon, and it serves an affiliative function.",,,
,Philemon,1,24,570010240040,ΛΟΥΚΑΣ,N/A,N/A,Identity,N/A,N/A,N/A,N/A,N/A,FALSE,Noun,N/A,N/A,N/A,N/A,FALSE,N/A,N/A,N/A,N/A,,N/A,,"This serves to introduce Luke to Philemon, and it serves an affiliative function.",,,
,Philemon,1,24,"570010240050, 570010240060",ΟΙ ΣΥΝΕΡΓΟΙ ΜΟΥ,N/A,Realis,Identity,N/A,N/A,Veridical,N/A,N/A,FALSE,DefiniteDescription,They are Paul's fellow workers,N/A,N/A,N/A,FALSE,N/A,N/A,N/A,"Appositive predication, Defining",Global implicit QUD: Who are these men?,They are Paul's fellow workers.,,"The appositive phrase is marked, as it emphasizes the strong commitment of these men to the gospel, and it serves an affiliative function.",,,
,Philemon,1,25,"570010250010, 570010250020, 570010250030, 570010250040, 570010250050",Η ΧΑΡΙΣ ΤΟΥ ΚΥΡΙΟΥ ΙΗΣΟΥ ΧΡΙΣΤΟΥ,N/A,Realis,Identity,N/A,N/A,Veridical,N/A,N/A,FALSE,Noun,N/A,N/A,N/A,N/A,FALSE,N/A,N/A,N/A,N/A,,N/A,,"Final closing formula. Paul is making a final wish for Philemon. Affiliative closing formula: Paul is blessing Philemon with the grace of the Lord Jesus Christ.",,,
`;

    // Global variables for data state
    let data = [];
    let headers = [];
    let enumColumns = {}; // Stores { columnName: { isEnum: boolean, options: Set<string> } }

    // --- 2. CSV UTILITIES ---

    /**
     * Parses a CSV string into an array of objects.
     * Handles quoted fields and multi-line content.
     * @param {string} csv - The raw CSV string.
     * @returns {{headers: string[], data: object[]}}
     */
    function parseCSV(csv) {
        const lines = csv.split(/\r?\n/).filter(line => line.trim() !== '');
        if (lines.length === 0) return { headers: [], data: [] };

        // Simple header parsing (assumes first line is header)
        const headers = lines[0].split(',').map(h => h.trim());

        const data = [];

        // Basic regex to split on commas, but not commas inside quotes.
        // This is a simplification but works for the provided data structure.
        const separator = /(?!\s*")\s*,\s*(?=\s*"|\s*\S)/g;

        for (let i = 1; i < lines.length; i++) {
            const line = lines[i];
            // Manually handle the split while respecting quotes
            const cells = [];
            let cell = '';
            let inQuotes = false;

            for (let j = 0; j < line.length; j++) {
                const char = line[j];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    cells.push(cell.trim().replace(/^"|"$/g, '').replace(/""/g, '"'));
                    cell = '';
                } else {
                    cell += char;
                }
            }
            cells.push(cell.trim().replace(/^"|"$/g, '').replace(/""/g, '"'));

            const rowObject = {};
            cells.forEach((value, index) => {
                if (headers[index]) {
                    rowObject[headers[index]] = value;
                }
            });
            // Assign a unique ID for tracking edits
            rowObject.__id = i;
            data.push(rowObject);
        }

        return { headers, data };
    }

    /**
     * Converts an array of objects back into a CSV string.
     * Escapes fields containing commas or quotes.
     * @param {object[]} data - The data array.
     * @param {string[]} headers - The column headers.
     * @returns {string}
     */
    function toCSV(data, headers) {
        const escapeValue = (value) => {
            if (value === null || value === undefined) return '';
            let str = String(value);
            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                // Double quotes and wrap in quotes
                return `"${str.replace(/"/g, '""')}"`;
            }
            return str;
        };

        const csvRows = [];
        // 1. Header Row
        csvRows.push(headers.map(escapeValue).join(','));

        // 2. Data Rows
        data.forEach(row => {
            const values = headers.map(header => escapeValue(row[header]));
            csvRows.push(values.join(','));
        });

        return csvRows.join('\n');
    }

    // --- 3. DATA PROCESSING AND RENDERING ---

    /**
     * Identifies enum columns and builds their initial options set.
     * A column is considered an enum if it has <= ENUM_THRESHOLD unique values.
     * @param {object[]} data - The current data array.
     */
    function identifyEnumColumns(data) {
        const columnValues = {};
        enumColumns = {};

        // 1. Collect all unique values for each column
        headers.forEach(header => {
            columnValues[header] = new Set();
        });

        data.forEach(row => {
            headers.forEach(header => {
                const value = row[header];
                if (value !== undefined && value !== null && value.trim() !== '') {
                    columnValues[header].add(value.trim());
                }
            });
        });

        // 2. Determine enum status and build initial options
        headers.forEach(header => {
            const uniqueValues = Array.from(columnValues[header]);
            const isEnum = uniqueValues.length > 0 && uniqueValues.length <= ENUM_THRESHOLD;

            enumColumns[header] = {
                isEnum: isEnum,
                options: new Set(uniqueValues)
            };
        });
    }

    /**
     * Renders the data table into the DOM.
     */
    function renderTable() {
        const thead = document.querySelector('#data-table thead');
        const tbody = document.querySelector('#data-table tbody');
        document.getElementById('loading-message').classList.add('hidden');

        // Clear existing content
        thead.innerHTML = '';
        tbody.innerHTML = '';

        // Render Header
        const headerRow = document.createElement('tr');
        headers.forEach(header => {
            const th = document.createElement('th');
            th.className = 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap';
            const enumBadge = enumColumns[header].isEnum ? '<span class="ml-1 text-indigo-500 text-xs">(Enum)</span>' : '';
            th.innerHTML = `${header}${enumBadge}`;
            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);

        // Render Body
        data.forEach((row, rowIndex) => {
            const tr = document.createElement('tr');
            tr.id = `row-${row.__id}`;
            tr.className = 'hover:bg-gray-50';

            headers.forEach((header, colIndex) => {
                const td = document.createElement('td');
                td.className = 'whitespace-nowrap text-sm text-gray-900 border-t border-gray-200';

                const value = row[header] || '';
                const colInfo = enumColumns[header];

                if (colInfo && colInfo.isEnum) {
                    // Create a dropdown (SELECT)
                    const select = document.createElement('select');
                    select.className = 'editable-select';
                    select.setAttribute('data-row-id', row.__id);
                    select.setAttribute('data-col-name', header);

                    // Add options dynamically
                    const currentOptions = Array.from(colInfo.options).sort();

                    // Ensure the current value is always an option
                    if (value && !colInfo.options.has(value)) {
                        currentOptions.unshift(value); // Add current value as the first option if it's missing
                    }

                    currentOptions.forEach(optionText => {
                        const option = document.createElement('option');
                        option.value = optionText;
                        option.textContent = optionText;
                        if (optionText === value) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });

                    select.addEventListener('change', (e) => handleEdit(row.__id, header, e.target.value));
                    td.appendChild(select);

                } else {
                    // Create a text input (TEXTAREA for multiline or long text)
                    const isLongText = value.length > 50 || value.includes('\n');
                    const input = document.createElement(isLongText ? 'textarea' : 'input');
                    input.className = 'editable-cell' + (isLongText ? ' resize-y' : '');
                    input.setAttribute('data-row-id', row.__id);
                    input.setAttribute('data-col-name', header);

                    if (isLongText) {
                        input.value = value;
                        input.rows = Math.max(3, Math.ceil(value.length / 50)); // Set rows based on length
                    } else {
                        input.type = 'text';
                        input.value = value;
                    }

                    // Use blur event to update data when editing stops
                    input.addEventListener('blur', (e) => handleEdit(row.__id, header, e.target.value));
                    td.appendChild(input);
                }

                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });
    }

    /**
     * Updates the internal data structure when a cell is edited.
     * @param {number} rowId - The unique ID of the row.
     * @param {string} colName - The name of the column.
     * @param {string} newValue - The new value from the input/select.
     */
    function handleEdit(rowId, colName, newValue) {
        const rowToUpdate = data.find(row => row.__id === rowId);
        if (rowToUpdate) {
            rowToUpdate[colName] = newValue.trim();

            // If it's an enum column, check if the new value needs to be added to options
            const colInfo = enumColumns[colName];
            if (colInfo && colInfo.isEnum && newValue.trim() !== '' && !colInfo.options.has(newValue.trim())) {
                colInfo.options.add(newValue.trim());
                // Re-render table to update all dropdowns with the new option
                // Note: This is computationally expensive for large tables, but ensures consistency.
                // For performance, a smarter targeted update could be used.
                // renderTable();
                // Let's rely on the user to manage options via the modal, or re-render only necessary selects.
                // To keep it simple and robust for this scope, we'll accept the new value in the row object,
                // but management is done via the modal.
            }
        }
    }

    // --- 4. OPTION MANAGEMENT MODAL LOGIC ---

    const modal = document.getElementById('options-modal');
    const modalContent = document.getElementById('modal-content');
    const columnSelect = document.getElementById('column-select');
    const optionsTextarea = document.getElementById('options-textarea');
    const modalMessage = document.getElementById('modal-message');

    /**
     * Opens the options management modal.
     */
    function openModal() {
        // 1. Populate the column select dropdown only with Enum columns
        columnSelect.innerHTML = '';
        const enumCols = headers.filter(h => enumColumns[h].isEnum);

        if (enumCols.length === 0) {
            modalMessage.textContent = "No enum columns detected (Unique values <= " + ENUM_THRESHOLD + "). Adjust the threshold or manually mark columns if needed.";
            modalMessage.classList.remove('hidden');
            optionsTextarea.value = '';
            document.getElementById('save-options-btn').disabled = true;
        } else {
            modalMessage.classList.add('hidden');
            document.getElementById('save-options-btn').disabled = false;
            enumCols.forEach(colName => {
                const option = document.createElement('option');
                option.value = colName;
                option.textContent = colName;
                columnSelect.appendChild(option);
            });

            // 2. Load options for the initially selected column
            loadOptionsForSelectedColumn();
        }

        // 3. Show modal with transition
        modal.classList.add('open');
        setTimeout(() => {
            modalContent.classList.remove('opacity-0', 'scale-95');
            modalContent.classList.add('opacity-100', 'scale-100');
        }, 10);
    }

    /**
     * Closes the options management modal.
     */
    function closeModal() {
        modalContent.classList.remove('opacity-100', 'scale-100');
        modalContent.classList.add('opacity-0', 'scale-95');
        setTimeout(() => {
            modal.classList.remove('open');
            modalMessage.classList.add('hidden');
        }, 300);
    }

    /**
     * Loads the options for the currently selected column into the textarea.
     */
    function loadOptionsForSelectedColumn() {
        const selectedCol = columnSelect.value;
        if (selectedCol && enumColumns[selectedCol]) {
            const optionsArray = Array.from(enumColumns[selectedCol].options).sort();
            optionsTextarea.value = optionsArray.join('\n');
        } else {
            optionsTextarea.value = '';
        }
    }

    /**
     * Saves the updated options from the textarea.
     */
    function saveOptions() {
        const selectedCol = columnSelect.value;
        if (!selectedCol) return;

        const newOptionsText = optionsTextarea.value;
        const newOptionsArray = newOptionsText
            .split('\n')
            .map(line => line.trim())
            .filter(line => line !== '');

        if (newOptionsArray.length === 0) {
            modalMessage.textContent = 'Options list cannot be empty. Please add at least one option.';
            modalMessage.classList.remove('hidden');
            return;
        }

        // Update global state
        enumColumns[selectedCol].options = new Set(newOptionsArray);

        // Re-render the entire table to update all dropdowns for this column
        renderTable();

        // Display success message temporarily
        modalMessage.classList.remove('hidden', 'text-red-500');
        modalMessage.classList.add('text-green-500');
        modalMessage.textContent = `Options for '${selectedCol}' saved successfully.`;

        setTimeout(() => {
            modalMessage.classList.add('hidden');
            modalMessage.classList.remove('text-green-500');
            modalMessage.classList.add('text-red-500');
            closeModal();
        }, 1000);
    }

    // --- 5. EXPORT AND INITIALIZATION ---

    /**
     * Exports the current data to a downloadable CSV file.
     */
    function exportData() {
        const csvContent = toCSV(data, headers);
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');

        // Set filename with a timestamp
        const date = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
        link.setAttribute('href', url);
        link.setAttribute('download', `InterpreSure_Annotations_edited_${date}.csv`);

        // Append to body, click, and remove
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    /**
     * Initial load function.
     */
    function initializeApp() {
        try {
            // 1. Load data from the pre-loaded string
            const result = parseCSV(RAW_CSV_DATA);
            headers = result.headers;
            data = result.data;

            // 2. Determine enum columns and options
            identifyEnumColumns(data);

            // 3. Render the table
            renderTable();

        } catch (error) {
            console.error("Error loading or processing data:", error);
            document.getElementById('loading-message').textContent = 'Error loading data: ' + error.message;
        }
    }

    // --- 6. EVENT LISTENERS ---

    document.getElementById('export-csv-btn').addEventListener('click', exportData);
    document.getElementById('manage-options-btn').addEventListener('click', openModal);

    // Modal Listeners
    document.getElementById('close-modal-btn').addEventListener('click', closeModal);
    document.getElementById('save-options-btn').addEventListener('click', saveOptions);
    columnSelect.addEventListener('change', loadOptionsForSelectedColumn);

    // Optional: File Upload Listener (if user wants to load a new file)
    document.getElementById('file-input').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            document.getElementById('loading-message').classList.remove('hidden');
            document.getElementById('loading-message').textContent = 'Loading custom file...';

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const result = parseCSV(event.target.result);
                    headers = result.headers;
                    data = result.data;
                    identifyEnumColumns(data);
                    renderTable();
                } catch (error) {
                    document.getElementById('loading-message').textContent = 'Error reading file. Check console for details.';
                    console.error('File Read Error:', error);
                }
            };
            reader.readAsText(file);
        }
    });

    // Initialize the app on load
    window.onload = initializeApp;

</script>
</body>
</html>
